<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jobs - Resumify</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <!-- Navigation and dropdown styles -->
    <link rel="stylesheet" href="styles/navigation.css">
    <link rel="stylesheet" href="styles/dropdown-fixes.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#FFF2C6',
                        'yellow': '#FFD646',
                        'mint': '#00D7AB',
                        'purple-light': '#DAA5FF',
                        'purple-dark': '#6628AD',
                        'blue': '#4EC4FE',
                        'red': '#F24E32',
                        'dark': '#191919'
                    },
                    fontFamily: {
                        'sora': ['Sora', 'sans-serif'],
                        'montserrat': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }

        .heading-font {
            font-family: 'Sora', sans-serif;
        }

        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }

        /* Navigation active state */
        .nav-link {
            position: relative;
        }

        .nav-link.active {
            color: rgb(255, 242, 198) !important;
            /* cream */
        }

        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, rgb(78, 196, 254), rgb(0, 215, 171));
            /* blue, mint */
            border-radius: 1px;
        }

        .glow-text {
            text-shadow: 0 0 20px rgba(78, 196, 254, 0.5);
            /* blue with opacity */
        }

        .glow-box {
            box-shadow: 0 0 30px rgba(78, 196, 254, 0.3);
            /* blue with opacity */
        }

        .gradient-border {
            background: linear-gradient(45deg, rgb(78, 196, 254), rgb(218, 165, 255), rgb(0, 215, 171));
            /* blue, purple-light, mint */
            padding: 2px;
            border-radius: 16px;
        }

        .gradient-border-inner {
            background: rgb(25, 25, 25);
            /* dark */
            border-radius: 14px;
        }

        /* Feature Cards Improvements */
        .feature-card {
            transition: all 0.3s ease;
            height: 100%;
        }

        .feature-card:hover {
            transform: translateY(-8px);
        }

        .feature-card:hover .card-text {
            color: rgb(255, 242, 198) !important;
            /* cream */
        }

        .feature-card .card-text {
            transition: color 0.3s ease;
            color: rgba(255, 242, 198, 0.9) !important;
            /* cream with opacity */
        }

        /* Improve gradient border visibility */
        .feature-card .gradient-border-inner {
            background: rgba(25, 25, 25, 0.98);
            /* dark with opacity */
        }

        /* Icon styles */
        .icon-container {
            transition: transform 0.3s ease;
        }

        .feature-card:hover .icon-container {
            transform: scale(1.1);
        }

        /* Logo link styles */
        .logo-link {
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
        }

        .logo-link:hover {
            transform: scale(1.05);
        }

        .logo-link:hover h1 {
            text-shadow: 0 0 20px rgba(78, 196, 254, 0.3);
        }
    </style>
</head>

<body class="bg-dark text-cream">
    <!-- Animated Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-20 left-10 w-72 h-72 bg-blue/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute top-40 right-20 w-96 h-96 bg-purple-light/20 rounded-full blur-3xl animate-pulse"
            style="animation-delay: 1s;"></div>
        <div class="absolute bottom-20 left-1/3 w-80 h-80 bg-mint/20 rounded-full blur-3xl animate-pulse"
            style="animation-delay: 2s;"></div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="max-w-7xl mx-auto px-6">
            <div class="nav-content">
                <div class="flex items-center">
                    <a href="/" class="logo-link" aria-label="Resumify Home">
                        <div>
                            <h1
                                class="text-3xl font-bold bg-gradient-to-r from-blue via-purple-light to-mint bg-clip-text text-transparent heading-font">
                                Resumify
                            </h1>
                            <p class="text-sm text-purple-light/70 font-montserrat">AI-Powered Matching</p>
                        </div>
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="desktop-nav">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/upload.html" class="nav-link">Upload</a>
                    <a href="/analysis.html" class="nav-link">Analysis</a>
                    <a href="/candidates.html" class="nav-link">Candidates</a>
                    <a href="/jobs.html" class="nav-link">Jobs</a>
                    <a href="/matches.html" class="nav-link">Matches</a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Toggle mobile menu"
                    aria-expanded="false">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="mobile-nav hidden">
                <div class="mobile-nav-links">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/upload.html" class="nav-link">Upload</a>
                    <a href="/analysis.html" class="nav-link">Analysis</a>
                    <a href="/candidates.html" class="nav-link">Candidates</a>
                    <a href="/jobs.html" class="nav-link">Jobs</a>
                    <a href="/matches.html" class="nav-link">Matches</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 min-h-screen bg-gradient-to-br from-dark via-purple-dark/20 to-dark pt-32 pb-20">
        <div class="max-w-7xl mx-auto px-6">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h1 class="text-4xl font-bold mb-2 heading-font">Job Openings</h1>
                    <p class="text-cream/80 text-lg font-montserrat">Browse available positions and requirements</p>
                </div>
                <button onclick="showAddJobModal()"
                    class="group relative px-8 py-4 bg-gradient-to-r from-blue to-mint rounded-xl font-semibold text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                    <span class="relative z-10">Add New Job</span>
                </button>
            </div>

            <!-- Search and Filters -->
            <div class="gradient-border mb-8">
                <div class="gradient-border-inner p-6">
                    <div class="flex flex-col md:flex-row gap-4">
                        <div class="flex-1">
                            <input type="text" id="searchInput"
                                placeholder="Search jobs by title, company, or skills..."
                                class="w-full px-4 py-3 bg-purple-light/10 border border-purple-light/30 rounded-xl text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat">
                        </div>
                        <div class="flex gap-2">
                            <select id="locationFilter"
                                class="dropdown-select px-4 py-3 bg-purple-light/10 border border-purple-light/30 rounded-xl text-cream focus:border-blue focus:outline-none transition-colors font-montserrat">
                                <option value="">All Locations</option>
                                <option value="remote">Remote</option>
                                <option value="bangalore">Bangalore</option>
                                <option value="mumbai">Mumbai</option>
                                <option value="delhi">Delhi</option>
                                <option value="hyderabad">Hyderabad</option>
                                <option value="pune">Pune</option>
                            </select>
                            <select id="experienceFilter"
                                class="dropdown-select px-4 py-3 bg-purple-light/10 border border-purple-light/30 rounded-xl text-cream focus:border-blue focus:outline-none transition-colors font-montserrat">
                                <option value="">All Experience</option>
                                <option value="0-2">0-2 years</option>
                                <option value="2-5">2-5 years</option>
                                <option value="5-10">5-10 years</option>
                                <option value="10+">10+ years</option>
                            </select>
                            <button onclick="refreshJobs()"
                                class="group relative px-4 py-3 bg-gradient-to-r from-blue to-mint rounded-xl font-semibold text-dark transition-all duration-300 hover:scale-105 glow-box">
                                <i data-lucide="refresh-cw" class="w-5 h-5"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center py-12">
                <div class="gradient-border mx-auto w-fit">
                    <div class="gradient-border-inner p-8">
                        <div
                            class="w-16 h-16 bg-gradient-to-r from-yellow to-mint rounded-2xl flex items-center justify-center mx-auto mb-4 animate-spin">
                            <i data-lucide="loader-2" class="w-8 h-8 text-dark"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-cream mb-2 heading-font">Loading Jobs...</h3>
                        <p class="text-cream/70 font-montserrat">Fetching job openings from database</p>
                    </div>
                </div>
            </div>

            <!-- Jobs Grid -->
            <div id="jobsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Job cards will be inserted here -->
            </div>

            <!-- No Jobs State -->
            <div id="noJobsState" class="hidden text-center py-12">
                <div
                    class="w-28 h-28 bg-gradient-to-r from-blue to-mint rounded-3xl flex items-center justify-center mx-auto mb-6 glow-box">
                    <i data-lucide="briefcase" class="w-12 h-12 text-dark"></i>
                </div>
                <h3 class="text-3xl font-bold text-cream mb-4 heading-font">No Jobs Found</h3>
                <p class="text-cream/70 mb-8 text-lg font-montserrat">Add some job openings to get started</p>
                <button onclick="showAddJobModal()"
                    class="group relative px-8 py-4 bg-gradient-to-r from-yellow via-mint to-blue rounded-2xl font-bold text-xl text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                    <span class="relative z-10">Add First Job</span>
                </button>
            </div>
        </div>
    </main>

    <!-- Add Job Modal -->
    <div id="addJobModal"
        class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="gradient-border w-full max-w-3xl max-h-[95vh] overflow-hidden">
            <div class="gradient-border-inner max-h-[95vh] overflow-y-auto">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-cream heading-font">Add New Job</h2>
                            <p class="text-cream/70 text-sm font-montserrat mt-1">Fill in the job details below. Fields
                                marked with * are required.</p>
                        </div>
                        <button onclick="hideAddJobModal()"
                            class="text-cream/70 hover:text-cream transition-colors p-2 hover:bg-cream/10 rounded-lg">
                            <i data-lucide="x" class="w-6 h-6"></i>
                        </button>
                    </div>

                    <!-- Form Progress Indicator -->
                    <div class="mb-6">
                        <div class="flex items-center justify-between text-sm text-cream/70 mb-2">
                            <span>Form Progress</span>
                            <span id="formProgress">0% Complete</span>
                        </div>
                        <div class="w-full bg-purple-light/20 rounded-full h-2">
                            <div id="progressBar"
                                class="bg-gradient-to-r from-blue to-mint h-2 rounded-full transition-all duration-300"
                                style="width: 0%"></div>
                        </div>
                    </div>

                    <form id="addJobForm" class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job Title
                                    *</label>
                                <input type="text" id="jobTitle" required
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                            </div>
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Company
                                    *</label>
                                <input type="text" id="jobCompany" required
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Location
                                    *</label>
                                <input type="text" id="jobLocation" required
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                            </div>
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Experience
                                    Required</label>
                                <input type="text" id="jobExperience" placeholder="e.g., 2-5 years"
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Salary
                                    Range</label>
                                <input type="text" id="jobSalary" placeholder="e.g., ₹8-15 LPA"
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                            </div>
                            <div>
                                <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job
                                    Type</label>
                                <select id="jobType"
                                    class="dropdown-select w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    <option value="full-time">Full Time</option>
                                    <option value="part-time">Part Time</option>
                                    <option value="contract">Contract</option>
                                    <option value="internship">Internship</option>
                                </select>
                            </div>
                        </div>

                        <div>
                            <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Required Skills
                                (comma separated)</label>
                            <div class="relative">
                                <textarea id="jobSkills" rows="2" placeholder="e.g., Python, React, AWS, Node.js"
                                    maxlength="500"
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm resize-none"></textarea>
                                <div class="text-xs text-cream/50 mt-1 flex justify-between">
                                    <span>Separate skills with commas (max 20 skills)</span>
                                    <span id="skillsCounter">0/500</span>
                                </div>
                            </div>
                        </div>


                        <div>
                            <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job
                                Description</label>
                            <div class="relative">
                                <textarea id="jobDescription" rows="3"
                                    placeholder="Additional details about the role, company culture, benefits..."
                                    maxlength="2000"
                                    class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm resize-none"></textarea>
                                <div class="text-xs text-cream/50 mt-1 text-right">
                                    <span id="descriptionCounter">0/2000</span>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-2">
                            <button type="submit"
                                class="flex-1 px-6 py-3 bg-gradient-to-r from-blue to-mint rounded-lg font-semibold text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat text-sm">
                                Add Job
                            </button>
                            <button type="button" onclick="hideAddJobModal()"
                                class="flex-1 px-4 py-3 border border-purple-light/50 rounded-lg text-purple-light hover:bg-purple-light/10 transition-colors font-montserrat text-sm">
                                Cancel
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/api-status.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/error-notifications.js"></script>
    <script src="js/dropdown-enhancements.js"></script>
    <script src="js/realtime-data-updates.js"></script>
    <script>
        let allJobs = [];
        let filteredJobs = [];
        let isInitialLoad = true;

        // Load jobs from DynamoDB with real-time update integration
        async function loadJobs() {
            try {
                console.log('Loading jobs...');
                const response = await window.resumifyAPI.getJobs();
                console.log('Jobs API response:', response);

                // Handle different response formats
                let jobsData = [];

                if (response && response.jobs && Array.isArray(response.jobs)) {
                    // Direct API response format: {jobs: [...], count: N}
                    jobsData = response.jobs;
                } else if (response && response.success && response.data) {
                    if (Array.isArray(response.data)) {
                        jobsData = response.data;
                    } else if (response.data.data && Array.isArray(response.data.data)) {
                        // API response format: {success: true, data: {data: [...], count: N}}
                        jobsData = response.data.data;
                    } else if (response.data.jobs && Array.isArray(response.data.jobs)) {
                        // API response format: {success: true, data: {jobs: [...], count: N}}
                        jobsData = response.data.jobs;
                    } else {
                        console.warn('Unexpected jobs response format:', response.data);
                        jobsData = [];
                    }
                } else if (response && Array.isArray(response)) {
                    jobsData = response;
                } else {
                    jobsData = [];
                }

                console.log('Processed jobs data:', jobsData);
                allJobs = jobsData;
                filteredJobs = [...allJobs];
                displayJobs();

            } catch (error) {
                console.error('Failed to load jobs:', error);
                document.getElementById('loadingState').classList.add('hidden');

                // Show error message for server issues
                if (error.message.includes('502') || error.message.includes('temporarily unavailable')) {
                    document.getElementById('noJobsState').innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-28 h-28 bg-gradient-to-r from-red/20 to-red/30 rounded-3xl flex items-center justify-center mx-auto mb-6">
                                <i data-lucide="server-off" class="w-12 h-12 text-red"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-cream mb-4 heading-font">Server Temporarily Unavailable</h3>
                            <p class="text-cream/70 mb-8 text-lg font-montserrat">Unable to load jobs at this time. Please try again in a few minutes.</p>
                            <button onclick="refreshJobs()" class="group relative px-8 py-4 bg-gradient-to-r from-mint to-yellow rounded-2xl font-bold text-xl text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                                <span class="relative z-10">Try Again</span>
                            </button>
                        </div>
                    `;
                } else {
                    document.getElementById('noJobsState').innerHTML = `
                        <div class="text-center py-12">
                            <div class="w-28 h-28 bg-gradient-to-r from-blue to-mint rounded-3xl flex items-center justify-center mx-auto mb-6 glow-box">
                                <i data-lucide="briefcase" class="w-12 h-12 text-dark"></i>
                            </div>
                            <h3 class="text-3xl font-bold text-cream mb-4 heading-font">No Jobs Found</h3>
                            <p class="text-cream/70 mb-8 text-lg font-montserrat">Add some job openings to get started</p>
                            <button onclick="showAddJobModal()" class="group relative px-8 py-4 bg-gradient-to-r from-yellow via-mint to-blue rounded-2xl font-bold text-xl text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                                <span class="relative z-10">Add First Job</span>
                            </button>
                        </div>
                    `;
                }

                document.getElementById('noJobsState').classList.remove('hidden');

                // Reinitialize icons
                lucide.createIcons();
            }
        }

        // Handle real-time jobs updates
        function handleJobsUpdate(newJobs, changeInfo) {
            // Update data
            allJobs = newJobs;

            // Apply current filters
            filterJobs();

            // Show notification for changes (but not on initial load)
            if (!isInitialLoad && changeInfo.changeType !== 'none') {
                window.realtimeDataUpdates.showChangeNotification('jobs', changeInfo);

                // Update page title indicator
                updatePageTitleIndicator('jobs', changeInfo);
            }

            isInitialLoad = false;
        }

        // Handle real-time update errors
        function handleJobsUpdateError(error) {
            console.error('Real-time jobs update error:', error);
            showAlert('Failed to update jobs data. Please refresh the page.', 'error');
        }

        // Update page title indicator
        function updatePageTitleIndicator(type, changeInfo) {
            const titleElement = document.querySelector('main h1');
            if (!titleElement) return;

            const originalTitle = 'Job Openings';

            if (changeInfo.changeType === 'added') {
                titleElement.textContent = `${originalTitle} (+${changeInfo.changeCount})`;
                titleElement.classList.add('text-mint');
            } else if (changeInfo.changeType === 'removed') {
                titleElement.textContent = `${originalTitle} (-${changeInfo.changeCount})`;
                titleElement.classList.add('text-yellow');
            }

            // Reset to normal after 3 seconds
            setTimeout(() => {
                titleElement.textContent = originalTitle;
                titleElement.classList.remove('text-mint', 'text-yellow');
            }, 3000);
        }

        // Display jobs
        function displayJobs() {
            document.getElementById('loadingState').classList.add('hidden');

            if (filteredJobs.length === 0) {
                document.getElementById('jobsGrid').classList.add('hidden');
                document.getElementById('noJobsState').classList.remove('hidden');
                return;
            }

            document.getElementById('noJobsState').classList.add('hidden');
            document.getElementById('jobsGrid').classList.remove('hidden');

            // Sort jobs by creation date (newest first)
            const sortedJobs = [...filteredJobs].sort((a, b) => {
                const dateA = new Date(a.createdAt || 0);
                const dateB = new Date(b.createdAt || 0);
                return dateB - dateA; // Newest first
            });

            const grid = document.getElementById('jobsGrid');
            grid.innerHTML = sortedJobs.map(job => createJobCard(job)).join('');

            // Reinitialize icons
            lucide.createIcons();
        }

        // Create job card HTML
        function createJobCard(job) {
            const skills = job.skills || job.requiredSkills || [];
            const skillsDisplay = skills.slice(0, 4).map(skill =>
                `<span class="bg-mint/20 text-mint px-3 py-1 rounded-full text-xs font-medium">${skill}</span>`
            ).join('');

            const moreSkills = skills.length > 4 ? `<span class="text-cream/70 text-xs">+${skills.length - 4} more</span>` : '';

            return `
                <div class="gradient-border group feature-card">
                    <div class="gradient-border-inner p-6 h-full">
                        <div class="flex items-start justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <div class="w-12 h-12 bg-gradient-to-r from-blue to-mint rounded-2xl flex items-center justify-center icon-container">
                                    <i data-lucide="briefcase" class="w-6 h-6 text-dark"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-cream heading-font">${job.title || 'Unknown'}</h3>
                                    <p class="text-cream/70 text-sm font-montserrat card-text">${job.company || 'Unknown Company'}</p>
                                </div>
                            </div>
                            <span class="px-3 py-1 rounded-full text-xs font-medium bg-gradient-to-r from-yellow/20 to-mint/20 text-yellow border border-yellow/30">
                                ${job.type || 'Full Time'}
                            </span>
                        </div>

                        <div class="space-y-2 mb-4">
                            <div class="flex justify-between text-sm">
                                <span class="text-cream/70 font-montserrat">Location:</span>
                                <span class="text-cream font-montserrat">${job.location || 'Not specified'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-cream/70 font-montserrat">Experience:</span>
                                <span class="text-cream font-montserrat">${job.experience || job.experienceRequired || 'Not specified'}</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-cream/70 font-montserrat">Salary:</span>
                                <span class="text-cream font-montserrat">${job.salary || job.salaryRange || 'Not disclosed'}</span>
                            </div>
                        </div>

                        ${skills.length > 0 ? `
                            <div class="mb-6">
                                <p class="text-cream/70 text-sm mb-3 font-montserrat">Required Skills:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${skillsDisplay}
                                    ${moreSkills}
                                </div>
                            </div>
                        ` : ''}

                        <div class="flex gap-2">
                            <button onclick="viewJob('${job.jobId}')" 
                                    class="flex-1 px-4 py-3 bg-gradient-to-r from-mint/20 to-yellow/20 hover:from-mint/30 hover:to-yellow/30 text-mint border border-mint/30 rounded-xl text-sm font-semibold transition-all duration-300 hover:scale-105 font-montserrat shadow-lg">
                                <i data-lucide="eye" class="w-4 h-4 inline mr-2"></i>
                                View Details
                            </button>
                            <button onclick="deleteJob('${job.jobId}')" 
                                    class="flex-1 px-3 py-2 bg-gradient-to-r from-red/20 to-red/20 hover:from-red/30 hover:to-red/30 text-red border border-red/30 rounded-xl text-sm transition-all duration-300 hover:scale-105 font-montserrat">
                                Delete Job
                            </button>
                        </div>

                    </div>
                </div>
            `;
        }

        // Search and filter functions
        function setupFilters() {
            const searchInput = document.getElementById('searchInput');
            const locationFilter = document.getElementById('locationFilter');
            const experienceFilter = document.getElementById('experienceFilter');

            searchInput.addEventListener('input', filterJobs);
            locationFilter.addEventListener('change', filterJobs);
            experienceFilter.addEventListener('change', filterJobs);
        }

        function filterJobs() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const locationFilter = document.getElementById('locationFilter').value.toLowerCase();
            const experienceFilter = document.getElementById('experienceFilter').value;

            filteredJobs = allJobs.filter(job => {
                const skills = job.skills || job.requiredSkills || [];
                const matchesSearch = !searchTerm ||
                    (job.title && job.title.toLowerCase().includes(searchTerm)) ||
                    (job.company && job.company.toLowerCase().includes(searchTerm)) ||
                    (skills.some(skill => skill.toLowerCase().includes(searchTerm)));

                const matchesLocation = !locationFilter ||
                    (job.location && job.location.toLowerCase().includes(locationFilter));

                const experience = job.experience || job.experienceRequired || '';
                const matchesExperience = !experienceFilter ||
                    (experience && experience.includes(experienceFilter));

                return matchesSearch && matchesLocation && matchesExperience;
            });

            displayJobs();
        }

        // Modal functions
        function showAddJobModal() {
            // Try multiple times to find the modal (in case of timing issues)
            let attempts = 0;
            const maxAttempts = 10;
            
            function tryShowModal() {
                const modal = document.getElementById('addJobModal');
                if (modal) {
                    modal.classList.remove('hidden');
                    return true;
                }
                
                attempts++;
                if (attempts < maxAttempts) {
                    setTimeout(tryShowModal, 100); // Try again after 100ms
                } else {
                    console.error('Add job modal not found in DOM after', maxAttempts, 'attempts');
                    console.log('Available elements with "modal" in ID:', 
                        Array.from(document.querySelectorAll('[id*="modal"]')).map(el => el.id));
                    
                    // Fallback: Try to create a simple modal
                    console.log('Attempting to create fallback modal...');
                    createFallbackModal();
                }
            }
            
            tryShowModal();
        }

        function createFallbackModal() {
            // Create a complete fallback modal if the main one is missing
            const modal = document.createElement('div');
            modal.id = 'addJobModal';
            modal.className = 'hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="gradient-border w-full max-w-3xl max-h-[95vh] overflow-hidden">
                    <div class="gradient-border-inner max-h-[95vh] overflow-y-auto">
                        <div class="p-6">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-2xl font-bold text-cream heading-font">Add New Job</h2>
                                <button onclick="hideAddJobModal()" class="text-cream/70 hover:text-cream transition-colors p-2 hover:bg-cream/10 rounded-lg">
                                    <i data-lucide="x" class="w-6 h-6"></i>
                                </button>
                            </div>
                            
                            <!-- Form Progress Indicator -->
                            <div class="mb-6">
                                <div class="flex items-center justify-between text-sm text-cream/70 mb-2">
                                    <span>Form Progress</span>
                                    <span id="formProgress">0% Complete</span>
                                </div>
                                <div class="w-full bg-purple-light/20 rounded-full h-2">
                                    <div id="progressBar" class="bg-gradient-to-r from-blue to-mint h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <form id="addJobForm" class="space-y-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job Title *</label>
                                        <input type="text" id="jobTitle" required class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Company *</label>
                                        <input type="text" id="jobCompany" required class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Location *</label>
                                        <input type="text" id="jobLocation" required class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Experience Required</label>
                                        <input type="text" id="jobExperience" placeholder="e.g., 2-5 years" class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Salary Range</label>
                                        <input type="text" id="jobSalary" placeholder="e.g., ₹8-15 LPA" class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job Type</label>
                                        <select id="jobType" class="dropdown-select w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream focus:border-blue focus:outline-none transition-colors font-montserrat text-sm">
                                            <option value="full-time">Full Time</option>
                                            <option value="part-time">Part Time</option>
                                            <option value="contract">Contract</option>
                                            <option value="internship">Internship</option>
                                        </select>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Required Skills (comma separated)</label>
                                    <div class="relative">
                                        <textarea id="jobSkills" rows="2" placeholder="e.g., Python, React, AWS, Node.js" maxlength="500" class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm resize-none"></textarea>
                                        <div class="text-xs text-cream/50 mt-1 flex justify-between">
                                            <span>Separate skills with commas (max 20 skills)</span>
                                            <span id="skillsCounter">0/500</span>
                                        </div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-cream font-semibold mb-1 font-montserrat text-sm">Job Description</label>
                                    <div class="relative">
                                        <textarea id="jobDescription" rows="3" placeholder="Describe the role, responsibilities, and what makes this opportunity unique..." maxlength="2000" class="w-full px-3 py-2 bg-purple-light/10 border border-purple-light/30 rounded-lg text-cream placeholder-cream/50 focus:border-blue focus:outline-none transition-colors font-montserrat text-sm resize-none"></textarea>
                                        <div class="text-xs text-cream/50 mt-1 text-right">
                                            <span id="descriptionCounter">0/2000</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-4 pt-4">
                                    <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue to-mint rounded-xl font-semibold text-dark transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                                        Add Job
                                    </button>
                                    <button type="button" onclick="hideAddJobModal()" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple to-purple-light rounded-xl font-semibold text-cream transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                                        Cancel
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.classList.remove('hidden');
            
            // Add form submit handler - use the same logic as the main form
            const form = modal.querySelector('#addJobForm');
            if (form) {
                // Remove any existing event listeners
                const newForm = form.cloneNode(true);
                form.parentNode.replaceChild(newForm, form);
                
                // Add the submit event listener
                newForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    // Show loading notification
                    const loadingNotification = showLoadingMessage('Validating form data...');
                    
                    // Validate form with enhanced feedback
                    if (!validateJobForm()) {
                        hideLoadingMessage();
                        showErrorMessage('Please fix the validation errors before submitting');
                        return;
                    }
                    
                    // Update loading message
                    loadingNotification.querySelector('.opacity-90').textContent = 'Preparing job data...';
                    
                    // Show loading state on submit button
                    const submitButton = e.target.querySelector('button[type="submit"]');
                    const cancelButton = e.target.querySelector('button[type="button"]');
                    const originalSubmitText = submitButton.textContent;
                    
                    submitButton.disabled = true;
                    cancelButton.disabled = true;
                    submitButton.innerHTML = `
                        <div class="flex items-center justify-center gap-2">
                            <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                            <span>${window.currentEditingJobId ? 'Updating Job...' : 'Creating Job...'}</span>
                        </div>
                    `;
                    submitButton.classList.add('opacity-75');
                    lucide.createIcons();
                    
                    // Prepare job data with validation
                    const jobData = {
                        title: document.getElementById('jobTitle').value.trim(),
                        company: document.getElementById('jobCompany').value.trim(),
                        location: document.getElementById('jobLocation').value.trim(),
                        experience: document.getElementById('jobExperience').value.trim() || null,
                        salary: document.getElementById('jobSalary').value.trim() || null,
                        type: document.getElementById('jobType').value,
                        skills: document.getElementById('jobSkills').value.trim()
                            ? document.getElementById('jobSkills').value.split(',').map(s => s.trim()).filter(s => s)
                            : [],
                        requirements: [],
                        description: document.getElementById('jobDescription').value.trim() || null
                    };
                    
                    try {
                        // Update loading message
                        loadingNotification.querySelector('.opacity-90').textContent = 'Submitting to server...';
                        
                        // Enable fast updates during job creation/update
                        enableFastUpdates();
                        
                        // Create new job
                        const response = await window.resumifyAPI.createJob(jobData);
                        
                        // Check for success based on the actual API response structure
                        if (response.message && response.message.includes('successfully') && (response.job || response.jobId)) {
                            hideLoadingMessage();
                            showSuccessMessage(`Job "${jobData.title}" created successfully! It will appear in the list shortly.`);
                            
                            // Close modal after brief delay
                            setTimeout(() => {
                                hideAddJobModal();
                            }, 1500);
                        } else {
                            hideLoadingMessage();
                            showErrorMessage('Failed to create job: ' + (response.error || 'Unknown error'));
                        }
                        
                    } catch (error) {
                        hideLoadingMessage();
                        console.error('Job creation failed:', error);
                        showErrorMessage('Failed to create job: ' + error.message);
                    } finally {
                        // Restore button state
                        submitButton.disabled = false;
                        cancelButton.disabled = false;
                        submitButton.innerHTML = originalSubmitText;
                        submitButton.classList.remove('opacity-75');
                        
                        // Disable fast updates
                        disableFastUpdates();
                    }
                });
            }
            
            // Add event listeners for form fields
            setupRealTimeValidation();
            
            console.log('Fallback modal created and shown');
        }

        function hideAddJobModal() {
            // Ensure DOM is ready
            if (document.readyState === 'loading') {
                return;
            }
            
            const modal = document.getElementById('addJobModal');
            const form = document.getElementById('addJobForm');
            
            if (modal) {
                modal.classList.add('hidden');
            }
            
            if (form) {
                form.reset();
            }

            // Clear all validation states
            clearFormErrors();

            // Remove any success indicators
            const successIndicators = document.querySelectorAll('.success-indicator');
            successIndicators.forEach(indicator => indicator.remove());
            
            // Reset modal title and button text
            const resetModal = document.getElementById('addJobModal');
            if (resetModal) {
                const title = resetModal.querySelector('h2');
                if (title) title.textContent = 'Add New Job';
                
                const submitBtn = resetModal.querySelector('button[type="submit"]');
                if (submitBtn) submitBtn.textContent = 'Add Job';
            }
            

            // Reset form styling
            const formFields = document.querySelectorAll('#addJobForm input, #addJobForm select, #addJobForm textarea');
            formFields.forEach(field => {
                field.classList.remove('border-red', 'border-mint', 'border-2');
                field.classList.add('border-purple-light/30');
            });

            // Reset progress bar
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('formProgress');
            if (progressBar && progressText) {
                progressBar.style.width = '0%';
                progressText.textContent = '0% Complete';
                progressText.className = 'text-cream/70 text-sm';
            }

            // Reset character counters
            const skillsCounter = document.getElementById('skillsCounter');
            const responsibilitiesCounter = document.getElementById('responsibilitiesCounter');
            const descriptionCounter = document.getElementById('descriptionCounter');
            if (skillsCounter) skillsCounter.textContent = '0/500';
            if (responsibilitiesCounter) responsibilitiesCounter.textContent = '0/1500';
            if (descriptionCounter) descriptionCounter.textContent = '0/2000';
        }

        // Enhanced form validation functions
        function validateJobForm() {
            const title = document.getElementById('jobTitle').value.trim();
            const company = document.getElementById('jobCompany').value.trim();
            const location = document.getElementById('jobLocation').value.trim();
            const experience = document.getElementById('jobExperience').value.trim();
            const salary = document.getElementById('jobSalary').value.trim();
            const skills = document.getElementById('jobSkills').value.trim();
            const description = document.getElementById('jobDescription').value.trim();

            // Clear previous error states
            clearFormErrors();

            let isValid = true;

            // Required field validations
            if (!title) {
                showFieldError('jobTitle', 'Job title is required');
                isValid = false;
            } else if (title.length < 3) {
                showFieldError('jobTitle', 'Job title must be at least 3 characters long');
                isValid = false;
            } else if (title.length > 100) {
                showFieldError('jobTitle', 'Job title must be less than 100 characters');
                isValid = false;
            }

            if (!company) {
                showFieldError('jobCompany', 'Company name is required');
                isValid = false;
            } else if (company.length < 2) {
                showFieldError('jobCompany', 'Company name must be at least 2 characters long');
                isValid = false;
            } else if (company.length > 100) {
                showFieldError('jobCompany', 'Company name must be less than 100 characters');
                isValid = false;
            }

            if (!location) {
                showFieldError('jobLocation', 'Location is required');
                isValid = false;
            } else if (location.length < 2) {
                showFieldError('jobLocation', 'Location must be at least 2 characters long');
                isValid = false;
            } else if (location.length > 100) {
                showFieldError('jobLocation', 'Location must be less than 100 characters');
                isValid = false;
            }

            // Optional field validations
            if (experience && experience.length > 50) {
                showFieldError('jobExperience', 'Experience requirement must be less than 50 characters');
                isValid = false;
            }

            if (salary && salary.length > 50) {
                showFieldError('jobSalary', 'Salary range must be less than 50 characters');
                isValid = false;
            }

            if (skills && skills.length > 500) {
                showFieldError('jobSkills', 'Skills list must be less than 500 characters');
                isValid = false;
            }

            if (description && description.length > 2000) {
                showFieldError('jobDescription', 'Job description must be less than 2000 characters');
                isValid = false;
            }

            // Skills format validation
            if (skills) {
                const skillsArray = skills.split(',').map(s => s.trim()).filter(s => s);
                if (skillsArray.length > 20) {
                    showFieldError('jobSkills', 'Maximum 20 skills allowed');
                    isValid = false;
                }

                // Check for invalid characters in skills
                const invalidSkills = skillsArray.filter(skill =>
                    skill.length < 2 || skill.length > 30 || !/^[a-zA-Z0-9\s\+\#\.\-]+$/.test(skill)
                );
                if (invalidSkills.length > 0) {
                    showFieldError('jobSkills', 'Skills must be 2-30 characters and contain only letters, numbers, spaces, +, #, ., -');
                    isValid = false;
                }
            }

            return isValid;
        }

        // Real-time field validation and character counting
        function setupRealTimeValidation() {
            const fields = [
                { id: 'jobTitle', validator: validateJobTitle },
                { id: 'jobCompany', validator: validateCompany },
                { id: 'jobLocation', validator: validateLocation },
                { id: 'jobExperience', validator: validateExperience },
                { id: 'jobSalary', validator: validateSalary },
                { id: 'jobSkills', validator: validateSkills, counter: 'skillsCounter', maxLength: 500 },
                { id: 'jobDescription', validator: validateDescription, counter: 'descriptionCounter', maxLength: 2000 }
            ];

            fields.forEach(field => {
                const element = document.getElementById(field.id);
                if (element) {
                    // Validate on blur (when user leaves field)
                    element.addEventListener('blur', () => {
                        clearFieldError(field.id);
                        const isValid = field.validator(element.value.trim(), field.id);
                        if (isValid && element.value.trim()) {
                            showFieldSuccess(field.id);
                        }
                    });

                    // Clear errors and update counters on input (while typing)
                    element.addEventListener('input', () => {
                        if (element.classList.contains('border-red')) {
                            clearFieldError(field.id);
                        }

                        // Update character counter
                        if (field.counter) {
                            updateCharacterCounter(field.id, field.counter, field.maxLength);
                        }

                        // Update form progress
                        updateFormProgress();
                    });

                    // Initialize character counters
                    if (field.counter) {
                        updateCharacterCounter(field.id, field.counter, field.maxLength);
                    }
                }
            });
        }

        function updateCharacterCounter(fieldId, counterId, maxLength) {
            const field = document.getElementById(fieldId);
            const counter = document.getElementById(counterId);

            if (field && counter) {
                const currentLength = field.value.length;
                counter.textContent = `${currentLength}/${maxLength}`;

                // Change color based on usage
                if (currentLength > maxLength * 0.9) {
                    counter.className = 'text-red text-xs';
                } else if (currentLength > maxLength * 0.7) {
                    counter.className = 'text-yellow text-xs';
                } else {
                    counter.className = 'text-cream/50 text-xs';
                }

                // Special handling for skills field
                if (fieldId === 'jobSkills') {
                    const skillsArray = field.value.split(',').map(s => s.trim()).filter(s => s);
                    const skillCount = skillsArray.length;

                    if (skillCount > 0) {
                        counter.textContent = `${currentLength}/${maxLength} (${skillCount} skills)`;

                        if (skillCount > 20) {
                            counter.className = 'text-red text-xs';
                        } else if (skillCount > 15) {
                            counter.className = 'text-yellow text-xs';
                        }
                    }
                }
            }
        }

        function updateFormProgress() {
            const requiredFields = ['jobTitle', 'jobCompany', 'jobLocation'];
            const optionalFields = ['jobExperience', 'jobSalary', 'jobSkills', 'jobDescription'];
            const allFields = [...requiredFields, ...optionalFields];

            let filledFields = 0;
            let totalWeight = 0;

            // Required fields have more weight
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    filledFields += 2; // Required fields count double
                }
                totalWeight += 2;
            });

            // Optional fields have normal weight
            optionalFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field && field.value.trim()) {
                    filledFields += 1;
                }
                totalWeight += 1;
            });

            const progressPercentage = Math.round((filledFields / totalWeight) * 100);

            // Update progress bar
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('formProgress');

            if (progressBar && progressText) {
                progressBar.style.width = `${progressPercentage}%`;
                progressText.textContent = `${progressPercentage}% Complete`;

                // Change color based on progress
                if (progressPercentage >= 100) {
                    progressBar.className = 'bg-gradient-to-r from-mint to-blue h-2 rounded-full transition-all duration-300';
                    progressText.className = 'text-mint text-sm font-semibold';
                } else if (progressPercentage >= 60) {
                    progressBar.className = 'bg-gradient-to-r from-yellow to-mint h-2 rounded-full transition-all duration-300';
                    progressText.className = 'text-yellow text-sm';
                } else {
                    progressBar.className = 'bg-gradient-to-r from-blue to-purple-light h-2 rounded-full transition-all duration-300';
                    progressText.className = 'text-cream/70 text-sm';
                }
            }
        }

        // Individual field validators
        function validateJobTitle(value, fieldId) {
            if (!value) return true; // Only validate if there's a value (required check is separate)
            if (value.length < 3) {
                showFieldError(fieldId, 'Job title must be at least 3 characters long');
                return false;
            }
            if (value.length > 100) {
                showFieldError(fieldId, 'Job title must be less than 100 characters');
                return false;
            }
            return true;
        }

        function validateCompany(value, fieldId) {
            if (!value) return true;
            if (value.length < 2) {
                showFieldError(fieldId, 'Company name must be at least 2 characters long');
                return false;
            }
            if (value.length > 100) {
                showFieldError(fieldId, 'Company name must be less than 100 characters');
                return false;
            }
            return true;
        }

        function validateLocation(value, fieldId) {
            if (!value) return true;
            if (value.length < 2) {
                showFieldError(fieldId, 'Location must be at least 2 characters long');
                return false;
            }
            if (value.length > 100) {
                showFieldError(fieldId, 'Location must be less than 100 characters');
                return false;
            }
            return true;
        }

        function validateExperience(value, fieldId) {
            if (!value) return true;
            if (value.length > 50) {
                showFieldError(fieldId, 'Experience requirement must be less than 50 characters');
                return false;
            }
            return true;
        }

        function validateSalary(value, fieldId) {
            if (!value) return true;
            if (value.length > 50) {
                showFieldError(fieldId, 'Salary range must be less than 50 characters');
                return false;
            }
            return true;
        }

        function validateSkills(value, fieldId) {
            if (!value) return true;
            if (value.length > 500) {
                showFieldError(fieldId, 'Skills list must be less than 500 characters');
                return false;
            }

            const skillsArray = value.split(',').map(s => s.trim()).filter(s => s);
            if (skillsArray.length > 20) {
                showFieldError(fieldId, 'Maximum 20 skills allowed');
                return false;
            }

            const invalidSkills = skillsArray.filter(skill =>
                skill.length < 2 || skill.length > 30 || !/^[a-zA-Z0-9\s\+\#\.\-]+$/.test(skill)
            );
            if (invalidSkills.length > 0) {
                showFieldError(fieldId, 'Skills must be 2-30 characters and contain only letters, numbers, spaces, +, #, ., -');
                return false;
            }

            return true;
        }

        function validateDescription(value, fieldId) {
            if (!value) return true;
            if (value.length > 2000) {
                showFieldError(fieldId, 'Job description must be less than 2000 characters');
                return false;
            }
            return true;
        }

        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            field.classList.add('border-red', 'border-2');
            field.classList.remove('border-purple-light/30');

            // Add shake animation for visual feedback
            field.classList.add('animate-pulse');
            setTimeout(() => field.classList.remove('animate-pulse'), 600);

            // Create or update error message
            let errorElement = field.parentNode.querySelector('.error-message');
            if (!errorElement) {
                errorElement = document.createElement('div');
                errorElement.className = 'error-message text-red text-sm mt-1 font-montserrat flex items-center gap-1';
                field.parentNode.appendChild(errorElement);
            }
            errorElement.innerHTML = `
                <i data-lucide="alert-circle" class="w-4 h-4"></i>
                <span>${message}</span>
            `;
            lucide.createIcons();
        }

        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            field.classList.remove('border-red', 'border-2');
            field.classList.add('border-purple-light/30');

            const errorElement = field.parentNode.querySelector('.error-message');
            if (errorElement) {
                errorElement.remove();
            }
        }

        function clearFormErrors() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(msg => msg.remove());

            const errorFields = document.querySelectorAll('.border-red');
            errorFields.forEach(field => {
                field.classList.remove('border-red', 'border-2');
                field.classList.add('border-purple-light/30');
            });
        }

        function showFieldSuccess(fieldId) {
            const field = document.getElementById(fieldId);
            field.classList.remove('border-red', 'border-2');
            field.classList.add('border-mint', 'border-2');

            // Add success icon temporarily
            let successElement = field.parentNode.querySelector('.success-indicator');
            if (!successElement) {
                successElement = document.createElement('div');
                successElement.className = 'success-indicator absolute right-3 top-1/2 transform -translate-y-1/2 text-mint';
                successElement.innerHTML = '<i data-lucide="check-circle" class="w-4 h-4"></i>';
                field.parentNode.style.position = 'relative';
                field.parentNode.appendChild(successElement);
                lucide.createIcons();

                // Remove success indicator after 2 seconds
                setTimeout(() => {
                    if (successElement.parentNode) {
                        successElement.remove();
                        field.classList.remove('border-mint', 'border-2');
                        field.classList.add('border-purple-light/30');
                    }
                }, 2000);
            }
        }

        function showSuccessMessage(message, duration = 4000) {
            // Create success notification with enhanced styling
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-mint to-blue text-dark px-6 py-4 rounded-xl font-semibold font-montserrat z-50 shadow-2xl transform translate-x-full transition-transform duration-300 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-dark/20 rounded-full flex items-center justify-center">
                        <i data-lucide="check-circle" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm">Success!</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-dark/70 hover:text-dark transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        function showErrorMessage(message, duration = 6000) {
            // Create error notification with enhanced styling
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-red to-yellow text-dark px-6 py-4 rounded-xl font-semibold font-montserrat z-50 shadow-2xl transform translate-x-full transition-transform duration-300 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-dark/20 rounded-full flex items-center justify-center">
                        <i data-lucide="alert-circle" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm">Error!</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-dark/70 hover:text-dark transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        function showWarningMessage(message, duration = 5000) {
            // Create warning notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-yellow to-mint text-dark px-6 py-4 rounded-xl font-semibold font-montserrat z-50 shadow-2xl transform translate-x-full transition-transform duration-300 max-w-sm';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-dark/20 rounded-full flex items-center justify-center">
                        <i data-lucide="alert-triangle" class="w-5 h-5"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm">Warning!</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" class="text-dark/70 hover:text-dark transition-colors">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            // Auto remove
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => notification.remove(), 300);
                }
            }, duration);
        }

        function showLoadingMessage(message) {
            // Create loading notification
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-4 bg-gradient-to-r from-blue to-purple-light text-dark px-6 py-4 rounded-xl font-semibold font-montserrat z-50 shadow-2xl transform translate-x-full transition-transform duration-300 max-w-sm';
            notification.id = 'loadingNotification';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-dark/20 rounded-full flex items-center justify-center">
                        <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                    </div>
                    <div class="flex-1">
                        <div class="font-bold text-sm">Processing...</div>
                        <div class="text-sm opacity-90">${message}</div>
                    </div>
                </div>
            `;

            document.body.appendChild(notification);
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);

            return notification;
        }

        function hideLoadingMessage() {
            const notification = document.getElementById('loadingNotification');
            if (notification) {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }
        }

        // Enhanced form submission with comprehensive validation and feedback
        document.getElementById('addJobForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            // Show loading notification
            const loadingNotification = showLoadingMessage('Validating form data...');

            // Validate form with enhanced feedback
            if (!validateJobForm()) {
                hideLoadingMessage();
                showErrorMessage('Please fix the validation errors before submitting');

                // Focus on first error field
                const firstErrorField = document.querySelector('.border-red');
                if (firstErrorField) {
                    firstErrorField.focus();
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            // Update loading message
            loadingNotification.querySelector('.opacity-90').textContent = 'Preparing job data...';

            // Show loading state on submit button
            const submitButton = e.target.querySelector('button[type="submit"]');
            const cancelButton = e.target.querySelector('button[type="button"]');
            const originalSubmitText = submitButton.textContent;

            submitButton.disabled = true;
            cancelButton.disabled = true;
            submitButton.innerHTML = `
                <div class="flex items-center justify-center gap-2">
                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    <span>Creating Job...</span>
                </div>
            `;
            submitButton.classList.add('opacity-75');
            lucide.createIcons();

            // Prepare job data with validation
            const jobData = {
                title: document.getElementById('jobTitle').value.trim(),
                company: document.getElementById('jobCompany').value.trim(),
                location: document.getElementById('jobLocation').value.trim(),
                experience: document.getElementById('jobExperience').value.trim() || null,
                salary: document.getElementById('jobSalary').value.trim() || null,
                type: document.getElementById('jobType').value,
                skills: document.getElementById('jobSkills').value.trim()
                    ? document.getElementById('jobSkills').value.split(',').map(s => s.trim()).filter(s => s)
                    : [],
                requirements: [], // No longer collecting responsibilities
                description: document.getElementById('jobDescription').value.trim() || null
            };

            try {
                // Update loading message
                loadingNotification.querySelector('.opacity-90').textContent = 'Submitting to server...';

                // Enable fast updates during job creation/update
                enableFastUpdates();

                // Create new job
                const response = await window.resumifyAPI.createJob(jobData);

                // Check for success based on the actual API response structure
                if (response.message && response.message.includes('successfully') && (response.job || response.jobId)) {
                    hideLoadingMessage();
                    showSuccessMessage(`Job "${jobData.title}" created successfully! It will appear in the list shortly.`);

                    // Show success feedback on form
                    const formElement = document.getElementById('addJobForm');
                    formElement.classList.add('opacity-50', 'pointer-events-none');

                    // Close modal after brief delay
                    setTimeout(() => {
                        hideAddJobModal();
                        formElement.classList.remove('opacity-50', 'pointer-events-none');
                    }, 1500);

                } else {
                    hideLoadingMessage();
                    const errorMsg = response.error || response.message || 'Unknown error occurred';
                    showErrorMessage(`Failed to create job: ${errorMsg}`);

                    // Log detailed error for debugging
                    console.error('Job creation failed:', response);
                }
            } catch (error) {
                hideLoadingMessage();
                console.error('Failed to create job:', error);

                let errorMessage = 'Failed to create job. ';
                if (error.message) {
                    errorMessage += error.message;
                } else if (error.response && error.response.data) {
                    errorMessage += error.response.data.message || 'Server error occurred';
                } else {
                    errorMessage += 'Please check your connection and try again.';
                }

                showErrorMessage(errorMessage);

                // Show retry option for network errors
                if (error.code === 'NETWORK_ERROR' || !navigator.onLine) {
                    showWarningMessage('Network connection issue detected. Please check your internet connection.');
                }

            } finally {
                // Reset button states
                submitButton.disabled = false;
                cancelButton.disabled = false;
                submitButton.innerHTML = originalSubmitText;
                submitButton.classList.remove('opacity-75');

                // Return to normal update speed after 30 seconds
                setTimeout(() => {
                    disableFastUpdates();
                }, 30000);
            }
        });

        function showJobModal(job) {
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="gradient-border max-w-4xl w-full max-h-[90vh] overflow-hidden">
                    <div class="gradient-border-inner bg-dark">
                        <div class="flex items-center justify-between p-6 border-b border-cream/20">
                            <div>
                                <h3 class="text-2xl font-semibold text-cream heading-font">${job.title}</h3>
                                <p class="text-cream/70 font-montserrat">${job.company} • ${job.location}</p>
                            </div>
                            <button onclick="closeJobModal()" class="text-cream/70 hover:text-cream transition-colors">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <div class="p-6 overflow-y-auto max-h-[70vh]">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                <div class="space-y-4">
                                    <div>
                                        <h4 class="text-cream font-semibold mb-2 font-montserrat">Job Details</h4>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between">
                                                <span class="text-cream/70">Type:</span>
                                                <span class="text-cream capitalize">${job.type || 'Full Time'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-cream/70">Experience:</span>
                                                <span class="text-cream">${job.experience || job.experienceRequired || 'Not specified'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-cream/70">Salary:</span>
                                                <span class="text-cream">${job.salary || job.salaryRange || 'Not disclosed'}</span>
                                            </div>
                                            <div class="flex justify-between">
                                                <span class="text-cream/70">Posted:</span>
                                                <span class="text-cream">${job.createdAt ? new Date(job.createdAt).toLocaleDateString() : 'Recently'}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <h4 class="text-cream font-semibold mb-2 font-montserrat">Required Skills</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${(job.skills || job.requiredSkills || []).map(skill => 
                                            `<span class="bg-mint/20 text-mint px-3 py-1 rounded-full text-xs font-medium">${skill}</span>`
                                        ).join('')}
                                        ${(job.skills || job.requiredSkills || []).length === 0 ? '<span class="text-cream/50 text-sm">No specific skills listed</span>' : ''}
                                    </div>
                                </div>
                            </div>
                            
                            
                            ${job.description ? `
                                <div class="mb-6">
                                    <h4 class="text-cream font-semibold mb-3 font-montserrat">Job Description</h4>
                                    <div class="bg-cream/5 rounded-xl p-4 border border-cream/10">
                                        <pre class="text-cream/90 font-montserrat text-sm whitespace-pre-wrap leading-relaxed">${job.description}</pre>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="flex justify-end gap-3 p-6 border-t border-cream/20">
                            <button onclick="closeJobModal()" 
                                    class="px-4 py-2 bg-gradient-to-r from-purple-light/20 to-blue/20 hover:from-purple-light/30 hover:to-blue/30 text-purple-light border border-purple-light/30 rounded-xl text-sm transition-all duration-300 font-montserrat">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            lucide.createIcons();
            
            // Close on backdrop click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeJobModal();
                }
            });
        }

        function closeJobModal() {
            const modal = document.querySelector('.fixed.inset-0.bg-black\\/50');
            if (modal) {
                modal.remove();
            }
        }

        // Action functions
        function viewJob(jobId) {
            // Find the job in our data
            const job = allJobs.find(j => j.jobId === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            showJobModal(job);
        }

        function deleteJob(jobId) {
            // Find the job in our data
            const job = allJobs.find(j => j.jobId === jobId);
            if (!job) {
                alert('Job not found');
                return;
            }
            
            // Confirm deletion
            if (confirm(`Are you sure you want to delete the job "${job.title}" at ${job.company}?\n\nThis action cannot be undone.`)) {
                performJobDeletion(jobId);
            }
        }

        async function performJobDeletion(jobId) {
            try {
                // Show loading state
                const loadingNotification = showLoadingMessage('Deleting job...');
                
                // Call API to delete job (we'll need to add this to the API)
                const response = await window.resumifyAPI.deleteJob(jobId);
                
                // Check for success based on the actual API response structure
                if (response.message && response.message.includes('successfully') && response.jobId) {
                    hideLoadingMessage();
                    showSuccessMessage('Job deleted successfully!');
                    
                    // Remove from local data and refresh display
                    allJobs = allJobs.filter(job => job.jobId !== jobId);
                    filteredJobs = filteredJobs.filter(job => job.jobId !== jobId);
                    displayJobs();
                } else {
                    hideLoadingMessage();
                    showErrorMessage('Failed to delete job: ' + (response.error || 'Unknown error'));
                }
                
            } catch (error) {
                hideLoadingMessage();
                console.error('Failed to delete job:', error);
                showErrorMessage('Failed to delete job: ' + error.message);
            }
        }


        function refreshJobs() {
            document.getElementById('jobsGrid').classList.add('hidden');
            document.getElementById('noJobsState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            loadJobs();
        }

        // Start real-time updates using the new system
        function startRealTimeUpdates() {
            window.realtimeDataUpdates.startJobsUpdates(
                handleJobsUpdate,
                handleJobsUpdateError
            );
        }

        // Stop real-time updates
        function stopRealTimeUpdates() {
            window.realtimeDataUpdates.stopUpdates('jobs');
        }

        // Enable fast updates during active operations
        function enableFastUpdates() {
            window.realtimeDataUpdates.enableFastUpdates('jobs');
        }

        // Disable fast updates
        function disableFastUpdates() {
            window.realtimeDataUpdates.disableFastUpdates('jobs');
        }

        // Show alert messages
        function showAlert(message, type = 'info') {
            // Create alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-20 right-4 z-50 p-4 rounded-xl shadow-lg transition-all duration-300 transform translate-x-full`;

            // Set colors based on type
            switch (type) {
                case 'error':
                    alertDiv.className += ' bg-red/20 border border-red/30 text-red';
                    break;
                case 'warning':
                    alertDiv.className += ' bg-yellow/20 border border-yellow/30 text-yellow';
                    break;
                case 'success':
                    alertDiv.className += ' bg-mint/20 border border-mint/30 text-mint';
                    break;
                default:
                    alertDiv.className += ' bg-blue/20 border border-blue/30 text-blue';
            }

            alertDiv.innerHTML = `
                <div class="flex items-center gap-3">
                    <i data-lucide="${type === 'error' ? 'alert-circle' : type === 'warning' ? 'alert-triangle' : type === 'success' ? 'check-circle' : 'info'}" class="w-5 h-5"></i>
                    <span class="font-montserrat text-sm">${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" class="ml-2 hover:opacity-70">
                        <i data-lucide="x" class="w-4 h-4"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(alertDiv);
            lucide.createIcons();

            // Animate in
            setTimeout(() => {
                alertDiv.classList.remove('translate-x-full');
            }, 100);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.classList.add('translate-x-full');
                    setTimeout(() => alertDiv.remove(), 300);
                }
            }, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            setupFilters();
            loadJobs();

            // Setup real-time form validation
            setupRealTimeValidation();

            // Start real-time updates
            startRealTimeUpdates();

            // Handle page unload to clean up intervals
            window.addEventListener('beforeunload', () => {
                stopRealTimeUpdates();
            });

            // Enhanced modal functionality
            const addJobModal = document.getElementById('addJobModal');
            if (addJobModal) {
                // Close modal on escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape' && !addJobModal.classList.contains('hidden')) {
                        hideAddJobModal();
                    }
                });

                // Close modal on backdrop click
                addJobModal.addEventListener('click', (e) => {
                    if (e.target === addJobModal) {
                        hideAddJobModal();
                    }
                });
            }

            // Mobile menu functionality
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');

            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function () {
                    mobileMenu.classList.toggle('hidden');

                    // Toggle menu icon
                    const icon = mobileMenuBtn.querySelector('i');
                    if (mobileMenu.classList.contains('hidden')) {
                        icon.setAttribute('data-lucide', 'menu');
                    } else {
                        icon.setAttribute('data-lucide', 'x');
                    }
                    lucide.createIcons();
                });
            }

            // Initialize icons
            lucide.createIcons();

            // Show welcome message on first visit
            if (!localStorage.getItem('jobsPageVisited')) {
                setTimeout(() => {
                    showSuccessMessage('Welcome to the Jobs page! Click "Add New Job" to create your first job posting.', 6000);
                    localStorage.setItem('jobsPageVisited', 'true');
                }, 1000);
            }
        });
    </script>
</body>

</html>