<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis - Resumify</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700;800;900&family=Montserrat:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    
    <!-- Navigation styles -->
    <link rel="stylesheet" href="styles/navigation.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'cream': '#FFF2C6',
                        'yellow': '#FFD646',
                        'mint': '#00D7AB',
                        'purple-light': '#DAA5FF',
                        'purple-dark': '#6628AD',
                        'blue': '#4EC4FE',
                        'red': '#F24E32',
                        'dark': '#191919'
                    },
                    fontFamily: {
                        'sora': ['Sora', 'sans-serif'],
                        'montserrat': ['Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            font-family: 'Montserrat', sans-serif;
        }
        .heading-font {
            font-family: 'Sora', sans-serif;
        }
        .font-montserrat {
            font-family: 'Montserrat', sans-serif;
        }
        
        /* Navigation active state */
        .nav-link {
            position: relative;
        }
        
        .nav-link.active {
            color: rgb(255, 242, 198) !important; /* cream */
        }
        
        .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, rgb(78, 196, 254), rgb(0, 215, 171)); /* blue, mint */
            border-radius: 1px;
        }
        
        .glow-text {
            text-shadow: 0 0 20px rgba(78, 196, 254, 0.5); /* blue with opacity */
        }
        .glow-box {
            box-shadow: 0 0 30px rgba(78, 196, 254, 0.3); /* blue with opacity */
        }
        .gradient-border {
            background: linear-gradient(45deg, rgb(78, 196, 254), rgb(218, 165, 255), rgb(0, 215, 171)); /* blue, purple-light, mint */
            padding: 2px;
            border-radius: 16px;
        }
        .gradient-border-inner {
            background: rgb(25, 25, 25); /* dark */
            border-radius: 14px;
        }
        
        /* Enhanced text formatting styles */
        .formatted-text {
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Montserrat', sans-serif;
        }
        
        .formatted-text p {
            margin-bottom: 1rem;
        }
        
        .text-content {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: rgba(25, 25, 25, 0.5);
            border-radius: 8px;
            border: 1px solid rgba(255, 242, 198, 0.1);
        }
        
        .text-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .text-content::-webkit-scrollbar-track {
            background: rgba(255, 242, 198, 0.1);
            border-radius: 4px;
        }
        
        .text-content::-webkit-scrollbar-thumb {
            background: rgba(0, 215, 171, 0.5);
            border-radius: 4px;
        }
        
        .text-content::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 215, 171, 0.7);
        }
        
        /* Logo link styles */
        .logo-link {
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
        }
        
        .logo-link:hover {
            transform: scale(1.05);
        }
        
        .logo-link:hover h1 {
            text-shadow: 0 0 20px rgba(78, 196, 254, 0.3);
        }
    </style>
</head>
<body class="bg-dark text-cream">
    <!-- Animated Background -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
        <div class="absolute top-20 left-10 w-72 h-72 bg-blue/20 rounded-full blur-3xl animate-pulse"></div>
        <div class="absolute top-40 right-20 w-96 h-96 bg-purple-light/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 1s;"></div>
        <div class="absolute bottom-20 left-1/3 w-80 h-80 bg-mint/20 rounded-full blur-3xl animate-pulse" style="animation-delay: 2s;"></div>
    </div>

    <!-- Navigation -->
    <nav>
        <div class="max-w-7xl mx-auto px-6">
            <div class="nav-content">
                <div class="flex items-center">
                    <a href="/" class="logo-link" aria-label="Resumify Home">
                        <div>
                            <h1 class="text-3xl font-bold bg-gradient-to-r from-blue via-purple-light to-mint bg-clip-text text-transparent heading-font">
                                Resumify
                            </h1>
                            <p class="text-sm text-purple-light/70 font-montserrat">AI-Powered Matching</p>
                        </div>
                    </a>
                </div>
                
                <!-- Desktop Navigation -->
                <div class="desktop-nav">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/upload.html" class="nav-link">Upload</a>
                    <a href="/analysis.html" class="nav-link">Analysis</a>
                    <a href="/candidates.html" class="nav-link">Candidates</a>
                    <a href="/jobs.html" class="nav-link">Jobs</a>
                    <a href="/matches.html" class="nav-link">Matches</a>
                </div>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="mobile-menu-btn" aria-label="Toggle mobile menu" aria-expanded="false">
                    <i data-lucide="menu" class="w-6 h-6"></i>
                </button>
            </div>

            <!-- Mobile Navigation Menu -->
            <div id="mobileMenu" class="mobile-nav hidden">
                <div class="mobile-nav-links">
                    <a href="/" class="nav-link">Home</a>
                    <a href="/upload.html" class="nav-link">Upload</a>
                    <a href="/analysis.html" class="nav-link">Analysis</a>
                    <a href="/candidates.html" class="nav-link">Candidates</a>
                    <a href="/jobs.html" class="nav-link">Jobs</a>
                    <a href="/matches.html" class="nav-link">Matches</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="relative z-10 min-h-screen bg-gradient-to-br from-dark via-purple-dark/20 to-dark pt-32 pb-20">
        <div class="max-w-7xl mx-auto px-6">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4 heading-font">Resume Analysis</h1>
            <p class="text-cream/80 text-lg font-montserrat">AI-powered analysis of resume content and skills</p>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="text-center py-12">
            <div class="w-16 h-16 border-4 border-cream/20 border-t-mint rounded-full animate-spin mx-auto mb-4"></div>
            <h3 class="text-xl font-semibold text-cream mb-2 heading-font">Loading Analysis...</h3>
            <p class="text-cream/70 font-montserrat">Fetching the latest analysis data</p>
        </div>

        <!-- Analysis Content -->
        <div id="analysisContent" class="hidden space-y-8">
            <!-- Candidate Info -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center heading-font">
                        <i data-lucide="user" class="w-6 h-6 mr-2 text-mint"></i>
                        Candidate Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="text-cream/70 text-sm font-montserrat">Name</label>
                            <p id="candidateName" class="text-cream font-semibold font-montserrat">-</p>
                        </div>
                        <div>
                            <label class="text-cream/70 text-sm font-montserrat">Email</label>
                            <p id="candidateEmail" class="text-cream font-semibold font-montserrat">-</p>
                        </div>
                        <div>
                            <label class="text-cream/70 text-sm font-montserrat">Analysis Date</label>
                            <p id="analysisDate" class="text-cream font-semibold font-montserrat">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Skills Analysis -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center heading-font">
                        <i data-lucide="brain" class="w-6 h-6 mr-2 text-yellow"></i>
                        Skills Analysis
                    </h2>
                    <div id="skillsContainer" class="space-y-4">
                        <div class="text-center text-cream/70 py-8">
                            <i data-lucide="search" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p class="font-montserrat">No skills data available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Experience Analysis -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center heading-font">
                        <i data-lucide="briefcase" class="w-6 h-6 mr-2 text-purple-light"></i>
                        Experience Analysis
                    </h2>
                    <div id="experienceContainer" class="space-y-4">
                        <div class="text-center text-cream/70 py-8">
                            <i data-lucide="search" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                            <p class="font-montserrat">No experience data available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Text Extraction Status -->
            <div class="gradient-border">
                <div class="gradient-border-inner p-6">
                    <h2 class="text-2xl font-bold mb-4 flex items-center heading-font">
                        <i data-lucide="file-text" class="w-6 h-6 mr-2 text-mint"></i>
                        Text Extraction
                    </h2>
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-cream/70 text-sm font-montserrat">Extraction Status</p>
                            <p id="extractionStatus" class="text-cream font-semibold font-montserrat">-</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="viewExtractedText()" class="group relative bg-gradient-to-r from-purple-light/20 to-purple-light/30 hover:from-purple-light/30 hover:to-purple-light/40 text-purple-light border border-purple-light/30 px-4 py-2 rounded-lg transition-all duration-300 hover:scale-105 font-montserrat">
                                <span class="relative z-10">View Text</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="flex flex-col sm:flex-row gap-4 justify-center">
                <button onclick="findMatches()" class="group relative bg-gradient-to-r from-purple-light/20 to-purple-light/30 hover:from-purple-light/30 hover:to-purple-light/40 text-purple-light border border-purple-light/30 px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 font-montserrat font-semibold">
                    <span class="relative z-10">Find Job Matches</span>
                </button>
                <button onclick="refreshAnalysis()" class="group relative bg-gradient-to-r from-cream/10 to-cream/20 hover:from-cream/20 hover:to-cream/30 text-cream border border-cream/30 px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 font-montserrat font-semibold">
                    <span class="relative z-10">Refresh Analysis</span>
                </button>
            </div>
        </div>

        <!-- No Data State -->
        <div id="noDataState" class="hidden text-center py-12">
            <div class="gradient-border w-fit mx-auto">
                <div class="gradient-border-inner p-8">
                    <div class="w-16 h-16 bg-gradient-to-r from-cream/10 to-cream/20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i data-lucide="search-x" class="w-8 h-8 text-cream/50"></i>
                    </div>
                    <h3 class="text-xl font-semibold text-cream mb-2 heading-font">No Analysis Found</h3>
                    <p class="text-cream/70 mb-6 font-montserrat">Upload a resume first to see analysis results</p>
                    <a href="/upload.html" class="group relative bg-gradient-to-r from-mint to-yellow text-dark font-semibold px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 glow-box font-montserrat inline-block">
                        <span class="relative z-10">Upload Resume</span>
                    </a>
                </div>
            </div>
        </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/api-status.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/error-notifications.js"></script>
    <script src="js/upload.js"></script>
    <script>
        let currentCandidateId = null;

        // Get candidate ID from URL params or session storage
        function getCurrentCandidateId() {
            const urlParams = new URLSearchParams(window.location.search);
            const candidateId = urlParams.get('candidateId') || sessionStorage.getItem('currentCandidateId');
            
            // Store in session storage for future use
            if (candidateId) {
                sessionStorage.setItem('currentCandidateId', candidateId);
            }
            
            return candidateId;
        }

        // Load analysis data
        async function loadAnalysis() {
            currentCandidateId = getCurrentCandidateId();
            
            if (!currentCandidateId) {
                console.log('No candidate ID found in URL parameters or session storage');
                document.getElementById('loadingState').classList.add('hidden');
                showNoDataState('No candidate selected', 'Please select a candidate from the candidates page to view their analysis.');
                return;
            }

            console.log('Loading analysis for candidate:', currentCandidateId);

            try {
                const response = await window.resumifyAPI.getAnalysis(currentCandidateId);
                
                // Handle both wrapped and direct response formats
                const data = response.success ? response.data : response;
                
                if (data) {
                    console.log('Analysis data loaded successfully:', data);
                    console.log('Experience data:', data.experience);
                    console.log('Skills data:', data.skills);
                    
                    // Store analysis data globally for access in displayExperience
                    window.currentAnalysisData = data;
                    
                    displayAnalysis(data);
                } else {
                    console.log('No analysis data found in response:', response);
                    throw new Error('No analysis data found for this candidate');
                }
            } catch (error) {
                console.error('Failed to load analysis:', error);
                document.getElementById('loadingState').classList.add('hidden');
                
                // Handle different error types with specific messages
                if (error.message.includes('502') || error.message.includes('temporarily unavailable')) {
                    showNoDataState(
                        'Server Temporarily Unavailable',
                        'The analysis service is currently down. Please try again in a few minutes.',
                        'server-off',
                        'red',
                        'Try Again',
                        'refreshAnalysis()'
                    );
                } else if (error.message.includes('404') || error.message.includes('not found')) {
                    showNoDataState(
                        'Analysis Not Found',
                        'No analysis exists for this candidate yet. The resume may still be processing or failed to process.',
                        'search-x',
                        'cream',
                        'Back to Candidates',
                        'window.location.href="/candidates.html"'
                    );
                } else if (error.message.includes('Analysis not found')) {
                    showNoDataState(
                        'Analysis Still Processing',
                        'The analysis for this candidate is still being processed. Please check back in a few minutes.',
                        'clock',
                        'yellow',
                        'Refresh',
                        'refreshAnalysis()'
                    );
                } else {
                    showNoDataState(
                        'Unable to Load Analysis',
                        'There was an error loading the analysis data. Please try again or contact support if the problem persists.',
                        'alert-circle',
                        'red',
                        'Try Again',
                        'refreshAnalysis()'
                    );
                }
            }
        }

        // Helper function to show different no data states
        function showNoDataState(title, message, icon = 'search-x', iconColor = 'cream', buttonText = 'Upload Resume', buttonAction = 'window.location.href="/upload.html"') {
            const iconColorClass = iconColor === 'red' ? 'from-red/20 to-red/30' : 
                                   iconColor === 'yellow' ? 'from-yellow/20 to-yellow/30' :
                                   'from-cream/10 to-cream/20';
            const iconTextColor = iconColor === 'red' ? 'text-red' : 
                                  iconColor === 'yellow' ? 'text-yellow' :
                                  'text-cream/50';

            document.getElementById('noDataState').innerHTML = `
                <div class="gradient-border w-fit mx-auto">
                    <div class="gradient-border-inner p-8">
                        <div class="w-16 h-16 bg-gradient-to-r ${iconColorClass} rounded-full flex items-center justify-center mx-auto mb-4">
                            <i data-lucide="${icon}" class="w-8 h-8 ${iconTextColor}"></i>
                        </div>
                        <h3 class="text-xl font-semibold text-cream mb-2 heading-font">${title}</h3>
                        <p class="text-cream/70 mb-6 font-montserrat">${message}</p>
                        <button onclick="${buttonAction}" class="group relative bg-gradient-to-r from-mint to-yellow text-dark font-semibold px-6 py-3 rounded-xl transition-all duration-300 hover:scale-105 glow-box font-montserrat">
                            <span class="relative z-10">${buttonText}</span>
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('noDataState').classList.remove('hidden');
            
            // Reinitialize icons
            lucide.createIcons();
        }

        // Clean skill name by removing percentage indicators and other unwanted formatting
        function cleanSkillName(skillName) {
            if (!skillName || typeof skillName !== 'string') {
                return skillName;
            }
            
            // Remove percentage indicators like "(80%)", " 80%", " - 80%", etc.
            const percentagePatterns = [
                /\s*\(\d+%\)/g,           // (80%)
                /\s*\(\d+\.\d+%\)/g,      // (85.5%)
                /\s*-\s*\d+%/g,           // - 80%
                /\s*:\s*\d+%/g,           // : 80%
                /\s*\d+%/g,               // 80%
                /\s*\(\d+\)/g,            // (80) - numbers in parentheses
                /\s*-\s*\d+/g,            // - 80
                /\s*:\s*\d+/g,            // : 80
                /\s*\((?:Advanced|Expert|Proficient|Intermediate|Beginner)\)/gi,  // (Advanced), (Expert), etc.
                /\s*-\s*(?:Advanced|Expert|Proficient|Intermediate|Beginner)/gi,  // - Advanced, - Expert, etc.
                /\s*:\s*(?:Advanced|Expert|Proficient|Intermediate|Beginner)/gi,  // : Advanced, : Expert, etc.
            ];
            
            let cleanedName = skillName.trim();
            
            // Apply each pattern to remove percentage indicators
            percentagePatterns.forEach(pattern => {
                cleanedName = cleanedName.replace(pattern, '');
            });
            
            // Clean up any trailing/leading whitespace and punctuation
            cleanedName = cleanedName.replace(/^[\s\-,:;]+|[\s\-,:;]+$/g, '');
            
            return cleanedName;
        }

        // Client-side skills extraction from extracted text
        function extractSkillsFromText(text) {
            if (!text || text === 'Processing...') return [];
            
            const textLower = text.toLowerCase();
            const skills = [];
            
            // Technical skills database
            const technicalSkills = {
                'Python': ['python', 'django', 'flask'],
                'JavaScript': ['javascript', 'js', 'node.js', 'nodejs'],
                'React': ['react', 'reactjs', 'react.js'],
                'Angular': ['angular', 'angularjs'],
                'Vue': ['vue', 'vuejs', 'vue.js'],
                'Java': ['java', 'spring'],
                'C++': ['c++', 'cpp'],
                'C#': ['c#', 'csharp', '.net'],
                'PHP': ['php', 'laravel'],
                'Ruby': ['ruby', 'rails'],
                'Go': ['go', 'golang'],
                'Swift': ['swift'],
                'Kotlin': ['kotlin'],
                'HTML': ['html', 'html5'],
                'CSS': ['css', 'css3', 'sass', 'scss'],
                'SQL': ['sql', 'mysql', 'postgresql'],
                'MongoDB': ['mongodb', 'mongo'],
                'AWS': ['aws', 'amazon web services'],
                'Docker': ['docker'],
                'Git': ['git', 'github'],
                'Linux': ['linux', 'ubuntu'],
                'Machine Learning': ['machine learning', 'ml'],
                'AI': ['artificial intelligence', 'ai']
            };
            
            // Soft skills
            const softSkills = [
                'Leadership', 'Communication', 'Teamwork', 'Problem Solving',
                'Project Management', 'Time Management', 'Adaptability', 'Creativity'
            ];
            
            // Find technical skills
            for (const [skill, variations] of Object.entries(technicalSkills)) {
                for (const variation of variations) {
                    if (textLower.includes(variation)) {
                        skills.push({
                            name: cleanSkillName(skill),
                            type: 'technical',
                            category: 'Technical',
                            confidence: 0.8
                        });
                        break;
                    }
                }
            }
            
            // Find soft skills
            for (const skill of softSkills) {
                if (textLower.includes(skill.toLowerCase())) {
                    skills.push({
                        name: cleanSkillName(skill),
                        type: 'soft',
                        category: 'Interpersonal',
                        confidence: 0.7
                    });
                }
            }
            
            // Additional extraction: Look for skills mentioned with percentages or proficiency levels
            const skillWithPercentagePattern = /([A-Za-z][A-Za-z\s\.\+\#]{1,20})\s*[\(\-\:]\s*(?:\d+%|\d+\.\d+%|Advanced|Expert|Proficient|Intermediate|Beginner|\d+\/\d+|\d+)/gi;
            
            let match;
            const foundSkillNames = new Set(skills.map(s => s.name.toLowerCase()));
            
            while ((match = skillWithPercentagePattern.exec(text)) !== null) {
                const potentialSkill = match[1].trim();
                const cleanedSkill = cleanSkillName(potentialSkill);
                
                // Only add if it's not already found and looks like a valid skill
                if (!foundSkillNames.has(cleanedSkill.toLowerCase()) && 
                    cleanedSkill.length >= 2 && 
                    cleanedSkill.length <= 25 &&
                    !['the', 'and', 'with', 'for', 'from', 'this', 'that', 'have', 'been', 'will', 'can', 'may'].includes(cleanedSkill.toLowerCase())) {
                    
                    foundSkillNames.add(cleanedSkill.toLowerCase());
                    skills.push({
                        name: cleanedSkill,
                        type: 'other',
                        category: 'Extracted',
                        confidence: 0.7
                    });
                }
            }
            
            return skills;
        }
        
        // Client-side experience extraction
        function extractExperienceFromText(text) {
            if (!text || text === 'Processing...') return [];
            
            const lines = text.split('\n');
            const experience = [];
            
            for (const line of lines) {
                const trimmedLine = line.trim();
                if (!trimmedLine) continue;
                
                // Look for job title patterns
                if (trimmedLine.match(/(engineer|developer|manager|analyst|designer|architect|consultant|specialist|lead|director)/i)) {
                    // Try to parse company and duration
                    const parts = trimmedLine.split(' - ');
                    if (parts.length >= 2) {
                        const title = parts[0].trim();
                        const remainder = parts.slice(1).join(' - ');
                        
                        // Look for years
                        const yearMatch = remainder.match(/(\d{4}\s*[-]\s*\d{4})/);
                        let company = remainder;
                        let duration = null;
                        
                        if (yearMatch) {
                            duration = yearMatch[1];
                            company = remainder.replace(yearMatch[1], '').trim(' -');
                        }
                        
                        experience.push({
                            title: title,
                            company: company || null,
                            duration: duration,
                            description: '',
                            responsibilities: []
                        });
                    }
                }
            }
            
            return experience.slice(0, 5); // Limit to 5 entries
        }

        // Display analysis data
        function displayAnalysis(data) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('analysisContent').classList.remove('hidden');

            // Candidate info - handle null values properly
            document.getElementById('candidateName').innerHTML = data.candidateName || data.name || '';
            document.getElementById('candidateEmail').innerHTML = data.candidateEmail || data.email || '';
            document.getElementById('analysisDate').innerHTML = data.createdAt ? 
                new Date(data.createdAt).toLocaleDateString() : '<span class="text-cream/50 italic">Not available</span>';

            // Extract skills and experience from text if not already analyzed
            let skills = data.skills || [];
            let experience = data.experience || [];
            
            // Convert backend experience format to frontend format
            if (Array.isArray(experience) && experience.length > 0) {
                // Check if it's already in the correct format (array of objects)
                if (typeof experience[0] === 'string') {
                    // Convert string array to object array
                    experience = experience.map(exp => ({
                        title: exp,
                        company: '',
                        duration: '',
                        description: ''
                    }));
                }
            }
            
            // If no skills but we have extracted text, extract them client-side
            if (skills.length === 0 && data.extractedText && data.extractedText !== 'Processing...') {
                skills = extractSkillsFromText(data.extractedText);
                if (isDevelopmentMode()) {
                    console.log('Extracted skills client-side:', skills.length);
                }
            }
            
            // If no experience but we have extracted text, extract it client-side
            if ((Array.isArray(experience) && experience.length === 0) || 
                (typeof experience === 'object' && Object.keys(experience).length === 0)) {
                if (data.extractedText && data.extractedText !== 'Processing...') {
                    experience = extractExperienceFromText(data.extractedText);
                    if (isDevelopmentMode()) {
                        console.log('Extracted experience client-side:', experience.length);
                    }
                }
            }

            // Display skills and experience
            displaySkills(skills);
            displayExperience(experience);

            // Extraction status
            document.getElementById('extractionStatus').innerHTML = 
                data.textExtractionStatus || 'Not available';
        }

        // Display skills
        function displaySkills(skills) {
            const container = document.getElementById('skillsContainer');
            
            if (!skills || skills.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-cream/70 py-8">
                        <i data-lucide="search" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p class="font-montserrat">No skills extracted yet</p>
                    </div>
                `;
                return;
            }

            // Handle both array of strings and array of objects, filtering out null/invalid skills
            const skillsToDisplay = skills
                .filter(skill => skill !== null && skill !== undefined && skill !== '')
                .map(skill => {
                    if (typeof skill === 'string') {
                        const cleanedName = cleanSkillName(skill);
                        // Skip if it's an "unknown" value or empty after cleaning
                        if (!cleanedName || cleanedName.toLowerCase().trim() === 'unknown' || cleanedName.toLowerCase().trim() === 'not specified') {
                            return null;
                        }
                        return { name: cleanedName, type: 'technical', confidence: 0.8 };
                    }
                    // Clean the skill name and skip if it's null or "unknown"
                    const cleanedName = cleanSkillName(skill.name);
                    if (!cleanedName || cleanedName.toLowerCase().trim() === 'unknown' || cleanedName.toLowerCase().trim() === 'not specified') {
                        return null;
                    }
                    return { ...skill, name: cleanedName };
                })
                .filter(skill => skill !== null);

            // Group skills by type
            const technicalSkills = skillsToDisplay.filter(s => s.type === 'technical');
            const softSkills = skillsToDisplay.filter(s => s.type === 'soft');
            const otherSkills = skillsToDisplay.filter(s => s.type !== 'technical' && s.type !== 'soft');

            container.innerHTML = `
                ${technicalSkills.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-cream mb-3 flex items-center heading-font">
                            <i data-lucide="code" class="w-5 h-5 mr-2 text-mint"></i>
                            Technical Skills
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${technicalSkills.map(skill => `
                                <span class="bg-gradient-to-r from-mint/20 to-mint/30 text-mint px-3 py-1 rounded-full text-sm border border-mint/30 font-montserrat hover:scale-105 transition-transform duration-200">
                                    ${skill.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${softSkills.length > 0 ? `
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-cream mb-3 flex items-center heading-font">
                            <i data-lucide="users" class="w-5 h-5 mr-2 text-yellow"></i>
                            Soft Skills
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${softSkills.map(skill => `
                                <span class="bg-gradient-to-r from-yellow/20 to-yellow/30 text-yellow px-3 py-1 rounded-full text-sm border border-yellow/30 font-montserrat hover:scale-105 transition-transform duration-200">
                                    ${skill.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${otherSkills.length > 0 ? `
                    <div>
                        <h3 class="text-lg font-semibold text-cream mb-3 flex items-center heading-font">
                            <i data-lucide="star" class="w-5 h-5 mr-2 text-purple-light"></i>
                            Other Skills
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${otherSkills.map(skill => `
                                <span class="bg-gradient-to-r from-purple-light/20 to-purple-light/30 text-purple-light px-3 py-1 rounded-full text-sm border border-purple-light/30 font-montserrat hover:scale-105 transition-transform duration-200">
                                    ${skill.name}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}
                
                ${technicalSkills.length === 0 && softSkills.length === 0 && otherSkills.length === 0 ? `
                    <div class="text-center text-cream/70 py-8">
                        <i data-lucide="search" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p class="font-montserrat">No valid skills extracted yet</p>
                    </div>
                ` : ''}
            `;
        }

        // Helper function to format field values with proper fallbacks
        function formatFieldValue(value, fallbackText = 'Not specified') {
            if (value === null || value === undefined || value === '' || 
                (typeof value === 'string' && value.toLowerCase().trim() === 'unknown')) {
                return `<span class="text-cream/50 italic">${fallbackText}</span>`;
            }
            return value;
        }

        // Display experience
        function displayExperience(experience) {
            const container = document.getElementById('experienceContainer');
            
            if (!experience || (Array.isArray(experience) && experience.length === 0) || 
                (typeof experience === 'object' && Object.keys(experience).length === 0)) {
                container.innerHTML = `
                    <div class="text-center text-cream/70 py-8">
                        <i data-lucide="search" class="w-12 h-12 mx-auto mb-2 opacity-50"></i>
                        <p class="font-montserrat">No experience data extracted yet</p>
                    </div>
                `;
                return;
            }

            // Handle array of experience objects
            if (Array.isArray(experience)) {
                container.innerHTML = `
                    <div class="space-y-4">
                        ${experience.map(exp => `
                            <div class="gradient-border">
                                <div class="gradient-border-inner p-4">
                                    <div class="flex justify-between items-start mb-2">
                                        <h3 class="text-cream font-semibold heading-font">${exp.title || ''}</h3>
                                        ${exp.duration ? `<span class="text-cream/70 text-sm font-montserrat">${exp.duration}</span>` : ''}
                                    </div>
                                    ${exp.company ? `<p class="text-mint text-sm mb-2 font-montserrat">${exp.company}</p>` : ''}
                                    ${exp.description && exp.description !== null ? `<p class="text-cream/80 text-sm font-montserrat">${exp.description}</p>` : ''}
                                    ${exp.responsibilities && Array.isArray(exp.responsibilities) && exp.responsibilities.length > 0 ? `
                                        <ul class="mt-2 space-y-1">
                                            ${exp.responsibilities.slice(0, 3).map(resp => `
                                                <li class="text-cream/70 text-sm flex items-start font-montserrat">
                                                    <span class="text-mint mr-2">•</span>
                                                    ${resp}
                                                </li>
                                            `).join('')}
                                        </ul>
                                    ` : ''}
                                    ${exp.yearsCalculated && exp.yearsCalculated > 0 ? `
                                        <div class="mt-2 text-xs text-cream/60 font-montserrat">
                                            <span class="bg-purple-light/20 px-2 py-1 rounded">
                                                ${exp.yearsCalculated} ${exp.yearsCalculated === 1 ? 'year' : 'years'} experience
                                            </span>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                // Handle object format - show complete work history
                // Get organizations and jobTitles from the main analysis data
                const analysisData = window.currentAnalysisData || {};
                const organizations = analysisData.organizations || [];
                const jobTitles = analysisData.jobTitles || [];
                const currentRole = experience.currentRole || '';
                const previousRoles = experience.previousRoles || [];
                
                console.log('🔍 Experience display debug:', {
                    analysisData: analysisData,
                    organizations: organizations,
                    jobTitles: jobTitles,
                    currentRole: currentRole,
                    previousRoles: previousRoles
                });
                
                container.innerHTML = `
                    <div class="space-y-4">
                        <!-- Summary Card -->
                        <div class="gradient-border">
                            <div class="gradient-border-inner p-4">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="text-cream/70 text-sm font-montserrat">Total Experience</label>
                                        <p class="text-cream font-semibold font-montserrat">${experience.totalYears || '0'} years</p>
                                    </div>
                                    <div>
                                        <label class="text-cream/70 text-sm font-montserrat">Current Role</label>
                                        <p class="text-cream font-semibold font-montserrat">${formatFieldValue(currentRole, 'Not specified')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Work History -->
                        ${organizations.length > 0 || jobTitles.length > 0 ? `
                            <div class="gradient-border">
                                <div class="gradient-border-inner p-4">
                                    <h3 class="text-cream font-semibold mb-3 heading-font flex items-center">
                                        <i data-lucide="briefcase" class="w-4 h-4 mr-2 text-mint"></i>
                                        Work History
                                    </h3>
                                    <div class="space-y-3">
                                        ${organizations.map((org, index) => {
                                            // Match job titles with companies in correct order
                                            let title;
                                            if (index === 0) {
                                                // First company gets current role
                                                title = currentRole || jobTitles[0] || 'Position';
                                            } else {
                                                // Subsequent companies get previous roles
                                                title = previousRoles[index - 1] || jobTitles[index] || 'Position';
                                            }
                                            
                                            return `
                                                <div class="flex items-center justify-between p-3 bg-dark/30 rounded-lg border border-cream/10">
                                                    <div class="flex-1">
                                                        <h4 class="text-cream font-medium font-montserrat">${title}</h4>
                                                        <p class="text-mint text-sm font-montserrat">${org}</p>
                                                    </div>
                                                    <div class="text-cream/60 text-xs font-montserrat">
                                                        ${index === 0 ? 'Current' : 'Previous'}
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                        
                                        ${jobTitles.length > organizations.length ? `
                                            ${jobTitles.slice(organizations.length).map((title, index) => `
                                                <div class="flex items-center justify-between p-3 bg-dark/30 rounded-lg border border-cream/10">
                                                    <div class="flex-1">
                                                        <h4 class="text-cream font-medium font-montserrat">${title}</h4>
                                                        <p class="text-cream/60 text-sm font-montserrat">Company not specified</p>
                                                    </div>
                                                    <div class="text-cream/60 text-xs font-montserrat">
                                                        Previous
                                                    </div>
                                                </div>
                                            `).join('')}
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${experience.summary ? `
                            <div class="gradient-border">
                                <div class="gradient-border-inner p-4">
                                    <h3 class="text-cream font-semibold mb-2 heading-font">Summary</h3>
                                    <p class="text-cream/80 text-sm font-montserrat">${formatFieldValue(experience.summary, 'Not available')}</p>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            }
        }

        // Action functions

        function findMatches() {
            if (currentCandidateId) {
                console.log('🔗 Navigating to matches page for candidate:', currentCandidateId);
                window.location.href = `/matches.html?candidateId=${currentCandidateId}`;
            } else {
                console.error('❌ No candidate ID available for matches navigation');
                alert('No candidate selected. Please refresh the page and try again.');
            }
        }

        function refreshAnalysis() {
            console.log('🔄 Refreshing analysis for candidate:', currentCandidateId);
            
            // Reset UI state
            document.getElementById('analysisContent').classList.add('hidden');
            document.getElementById('noDataState').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            
            // Reload analysis
            loadAnalysis();
        }

        // Format text for display with proper paragraph breaks
        function formatTextForDisplay(text) {
            if (!text || text === 'Processing...' || text === 'Text extraction failed') {
                return text;
            }
            
            // Convert double newlines to paragraph breaks and single newlines to line breaks
            let formatted = text
                .replace(/\n\n/g, '</p><p>')  // Double newlines become paragraph breaks
                .replace(/\n/g, '<br>')       // Single newlines become line breaks
                .replace(/^/, '<p>')          // Add opening paragraph tag
                .replace(/$/, '</p>');        // Add closing paragraph tag
            
            // Clean up empty paragraphs
            formatted = formatted.replace(/<p><\/p>/g, '');
            formatted = formatted.replace(/<p><br><\/p>/g, '');
            
            return formatted;
        }

        // View extracted text in modal
        async function viewExtractedText() {
            if (!currentCandidateId) return;
            
            try {
                const response = await window.resumifyAPI.getAnalysis(currentCandidateId);
                // Handle both wrapped and direct response formats
                const data = response.success ? response.data : response;
                
                if (data && data.extractedText) {
                    const extractedText = data.extractedText;
                    const formattedText = formatTextForDisplay(extractedText);
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4';
                    modal.innerHTML = `
                        <div class="gradient-border max-w-4xl w-full max-h-[80vh] overflow-hidden">
                            <div class="gradient-border-inner">
                                <div class="flex justify-between items-center p-6 border-b border-cream/20">
                                    <h3 class="text-xl font-bold text-cream heading-font">Extracted Text</h3>
                                    <div class="flex items-center gap-4">
                                        <button id="toggleFormat" class="text-cream/70 hover:text-mint transition-colors duration-200 text-sm font-montserrat">
                                            Toggle Format
                                        </button>
                                        <button onclick="this.closest('.fixed').remove()" class="text-cream/70 hover:text-cream transition-colors duration-200 hover:scale-110">
                                            <i data-lucide="x" class="w-6 h-6"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-6 overflow-y-auto max-h-[60vh]">
                                    <div class="gradient-border">
                                        <div class="gradient-border-inner p-4">
                                            <div class="flex justify-between items-center mb-4">
                                                <span class="text-cream/70 text-sm font-montserrat">Characters: ${extractedText.length}</span>
                                                <span class="text-cream/70 text-sm font-montserrat">Words: ${extractedText.split(/\s+/).length}</span>
                                            </div>
                                            <div class="text-content">
                                                <div id="formattedView" class="text-cream text-sm formatted-text leading-relaxed font-montserrat">${formattedText}</div>
                                                <pre id="rawView" class="text-cream text-sm whitespace-pre-wrap font-mono leading-relaxed hidden">${extractedText}</pre>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex justify-end gap-2 p-6 border-t border-cream/20">
                                    <button class="copy-text-btn group relative bg-gradient-to-r from-mint/10 to-mint/20 hover:from-mint/20 hover:to-mint/30 text-mint border border-mint/30 px-4 py-2 rounded-lg transition-all duration-300 hover:scale-105 font-montserrat">
                                        <span class="relative z-10">Copy Text</span>
                                    </button>
                                    <button onclick="this.closest('.fixed').remove()" class="group relative bg-gradient-to-r from-cream/10 to-cream/20 hover:from-cream/20 hover:to-cream/30 text-cream border border-cream/30 px-4 py-2 rounded-lg transition-all duration-300 hover:scale-105 font-montserrat">
                                        <span class="relative z-10">Close</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.appendChild(modal);
                    
                    // Add event listener for copy button
                    const copyBtn = modal.querySelector('.copy-text-btn');
                    if (copyBtn) {
                        copyBtn.addEventListener('click', async () => {
                            try {
                                await navigator.clipboard.writeText(extractedText);
                                const originalText = copyBtn.querySelector('span').textContent;
                                copyBtn.querySelector('span').textContent = 'Copied!';
                                copyBtn.classList.add('bg-gradient-to-r', 'from-yellow/20', 'to-yellow/30', 'text-yellow');
                                
                                setTimeout(() => {
                                    copyBtn.querySelector('span').textContent = originalText;
                                    copyBtn.classList.remove('bg-gradient-to-r', 'from-yellow/20', 'to-yellow/30', 'text-yellow');
                                }, 2000);
                            } catch (error) {
                                console.error('Failed to copy text:', error);
                                copyBtn.querySelector('span').textContent = 'Failed to copy';
                                setTimeout(() => {
                                    copyBtn.querySelector('span').textContent = 'Copy Text';
                                }, 2000);
                            }
                        });
                    }
                    
                    // Add toggle functionality
                    const toggleBtn = modal.querySelector('#toggleFormat');
                    const formattedView = modal.querySelector('#formattedView');
                    const rawView = modal.querySelector('#rawView');
                    
                    toggleBtn.addEventListener('click', () => {
                        if (formattedView.classList.contains('hidden')) {
                            formattedView.classList.remove('hidden');
                            rawView.classList.add('hidden');
                            toggleBtn.textContent = 'Raw View';
                        } else {
                            formattedView.classList.add('hidden');
                            rawView.classList.remove('hidden');
                            toggleBtn.textContent = 'Formatted View';
                        }
                    });
                    
                    lucide.createIcons();
                } else {
                    alert('No extracted text available');
                }
            } catch (error) {
                console.error('Failed to load extracted text:', error);
                alert('Failed to load extracted text');
            }
        }
        
        // Copy text to clipboard
        async function copyToClipboard(text, button) {
            try {
                await navigator.clipboard.writeText(text);
                const originalText = button.querySelector('span').textContent;
                button.querySelector('span').textContent = 'Copied!';
                button.classList.add('bg-gradient-to-r', 'from-yellow/20', 'to-yellow/30', 'text-yellow');
                
                setTimeout(() => {
                    button.querySelector('span').textContent = originalText;
                    button.classList.remove('bg-gradient-to-r', 'from-yellow/20', 'to-yellow/30', 'text-yellow');
                }, 2000);
            } catch (error) {
                console.error('Failed to copy text:', error);
                alert('Failed to copy text to clipboard');
            }
        }



        // Debug function to check if we're in development mode
        function isDevelopmentMode() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            // Add debug information if in development mode
            if (isDevelopmentMode()) {
                console.log('🔍 Analysis page initialized');
                console.log('🔍 Current URL:', window.location.href);
                console.log('🔍 URL parameters:', Object.fromEntries(new URLSearchParams(window.location.search)));
                console.log('🔍 Session storage candidateId:', sessionStorage.getItem('currentCandidateId'));
            }
            
            loadAnalysis();
            lucide.createIcons();
            
            // Mobile menu functionality
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobileMenu');
            
            if (mobileMenuBtn && mobileMenu) {
                mobileMenuBtn.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                    
                    // Toggle menu icon
                    const icon = mobileMenuBtn.querySelector('i');
                    if (mobileMenu.classList.contains('hidden')) {
                        icon.setAttribute('data-lucide', 'menu');
                    } else {
                        icon.setAttribute('data-lucide', 'x');
                    }
                    lucide.createIcons();
                });
            }
        });
    </script>
</body>
</html>